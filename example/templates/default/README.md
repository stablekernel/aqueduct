# wildfire

An application built with [aqueduct](https://github.com/stablekernel/aqueduct).

## First Time Setup

If you have not yet, run:

```
aqueduct setup
```

This command creates a local test database that this application's tests will run against. The test harness (`test/harness/app.dart`) takes care of creating tables in this database prior to executing the tests.

## Running Tests

Running tests locally are the preferred way of verifying development tasks.

To run all tests for this application, run the following command in this directory:

```
pub run test -j 1
```

The application harness will provision the test database, start an instance of this application, execute HTTP requests against it, and then close the application. Test cases will execute HTTP requests against the test application instance.

You must run the tests with option `-j 1` to ensure tests run synchronously. Otherwise, concurrently running test files will fail because they cannot listen for HTTP requests on the same port.

The test database is provisioned with *temporary* tables, which only exist for the length of the connection. Therefore, tests are always run with a 'clean' database. The tables are generated by evaluating all of the declared `ManagedObject`s in this application and any of its dependencies. It is important that you don't create tables in the test database outside of the tests.

The connection information for the test database is stored in `config.yaml.src`. The file is checked into source control and contains configuration values for the test environment, whether that is local or in TravisCI. The current values are set up to connect to the database created by `aqueduct setup`. (The file `config.yaml` is derived from `config.yaml.src` and explained in 'Running wildfire'.)

## Deployment

See the [Deployment Guides](http://stablekernel.github.io/aqueduct/guides/deployment.html)

### AWS

### Heroku

### Local

To run this application (locally or remotely), you must provision a PostgreSQL database, add the application's schema to a database, add database records for at least one OAuth 2.0 client, and then run this application's code.

### Provisioning the Database

A database serving an Aqueduct application should have two database users: an admin user and an application user. The admin user executes migration files, which modify the database schema to match this application's ORM code. This application's ORM connects as an application user. The application user should not have privileges to modify the schema.

Installation of PostgreSQL is outside the scope of this document, as many services provide installation (such as AWS, Heroku or locally with Postgres.app). Once a PostgreSQL installation is running, connect to it and create a new database and an admin user. (A hosted database solution may already have a database and admin user, if so, do not enter the next block of SQL.)

```sql
CREATE DATABASE wildfire;

CREATE USER wildfire_admin;
ALTER USER wildfire_admin WITH PASSWORD 'yourpassword';
GRANT ALL ON DATABASE wildfire TO wildfire_admin;
```

Then, you can create an application user that has less privileges.

Then, create an application user that has less privileges. Make sure you are connected to the database `wildfire` by entering `\c wildfire` from the `psql` shell.

```sql
CREATE USER wildfire_app;
ALTER USER wildfire_app WITH PASSWORD 'yourpassword';
GRANT CONNECT ON DATABASE wildfire TO wildfire_app;
ALTER DEFAULT PRIVILEGES FOR ROLE wildfire_admin GRANT SELECT, INSERT, UPDATE, DELETE, TRUNCATE ON TABLES TO wildfire_app;
ALTER DEFAULT PRIVILEGES FOR ROLE wildfire_admin GRANT USAGE, SELECT, UPDATE ON SEQUENCES TO wildfire_app;
```

### Generating the Database Schema (PostgreSQL)

Aqueduct generates database migration files and has a tool to execute those migration files on a database. A database migration file is created by comparing the current declarations of `ManagedObject`s in this application's code against the database generated by existing migration files. These files are stored in the `migrations` directory. To create a migration file, run the following command from this project's directory:

```
aqueduct db generate
```

The initial migration file is always named `00000001_Initial.migration.dart` and contains instructions to create tables for every `ManagedObject` declared in this application's code. Subsequent migration files will contain instructions to modify the schema generated by all migration files, plus any changes to the application's code. Migration files are versioned according to their filename, anything before the underscore (`_`) is the version number. Leading zeros are trimmed, but exist to allow the filesystem to sort migration files according to their version number.

At any time, you can delete migration files and run `aqueduct db generate` again. Any migration files that still exist in the directory (which may be none) will be compared with the current schema declared in the application's code, and a new migration file will be created. This means that you can create migration files for the purpose of provisioning a development database, but coalesce changes into a single migration file before deployment to a production database.

Migration files are executed on a database by using `aqueduct db upgrade`. When this tool is run inside this project's directory, it connects to a database to determine the current database version and runs migration files in `migrations` to upgrade the database schema to the latest migration file. Each migration file's version number and the time of the migration is added to a table in the database. Database connection information is stored in a file named `migrations/migration.yaml`. The file `migrations/migration.yaml.src` is a template for what this file should look like.


Configure the connection information for the database in `migrations/migration.yaml`. The specified username must have the privileges to create tables.
(The file `migrations/migration.yaml.src` is a template for `migrations/migration.yaml`.)

You may copy and edit the migration template file:

```
cp migrations/migration.yaml.src migrations/migration.yaml
```

Run the migration generation tool:

```
aqueduct db generate
```

You may review the migration in `migrations/00000001_Initial.migration.dart`. To add the schema to the database defined in `migrations/migration.yaml`, run the migration upgrade command:

```
aqueduct db upgrade
```

You may create subsequent migration files with `aqueduct db generate`. Note that at this time, only the first migration file is fully generated. You will have to manually write migration code for subsequent migrations. Use the following command to validate if migrations will result in the data model in this application:

```
aqueduct db validate
```

### Running wildfire

In deployment, the configuration file is named config.yaml. This file is not checked into source control by default, as it can contain sensitive information.

Ensure that a `config.yaml` file exists in this directory. (The file `config.yaml.src` is a template for `config.yaml`.)

You may copy and edit config template file:

```
cp config.yaml.src config.yaml
```

Give executable permissions for the application script:

```
chmod a+x wildfire
```

Then, start the server:

```
./wildfire start
```

## Creating API Documentation

Run the following script from this directory to generate an OpenAPI 2.0 JSON specification file for your web server:

```
dart bin/document.dart
```

This will print a JSON OpenAPI specification to stdout.
