
<!DOCTYPE html>
<html class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Documentation for Aqueduct, a Dart server-side framework.">
      
      
      
      
        <link rel="shortcut icon" href="../../assets/images/favicon.png">
      
      <meta name="generator" content="mkdocs-0.16.1, mkdocs-material-1.1.1">
    
    
      
        <title>Advanced Queries - Aqueduct</title>
      
    
    
      <script src="../../assets/javascripts/modernizr-56ade86843.js"></script>
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application-4ebe3f1d68.css">
      
    
    
      
        
        
        
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
    
      <link rel="stylesheet" href="../../style/css/override.css">
    
    
  </head>
  
  
  
  
    <body>
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="drawer">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="search">
    <label class="md-overlay" data-md-component="overlay" for="drawer"></label>
    
      <header class="md-header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <a href="../.." title="Aqueduct" class="md-icon md-icon--home md-header-nav__button">
          </a>
        
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <span class="md-flex__ellipsis md-header-nav__title">
          
            
              
                <span class="md-header-nav__parent">
                  Database/ORM
                </span>
              
            
            Advanced Queries
          
        </span>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="search"></label>
          
<div class="md-search" data-md-component="search">
  <div class="md-search__overlay"></div>
  <div class="md-search__inner">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" accesskey="s" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query">
      <label class="md-icon md-search__icon" for="search"></label>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result"></div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <div class="md-header-nav__source">
          
            


  


  <a href="https://github.com/stablekernel/aqueduct" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      GitHub
    </div>
  </a>

          
        </div>
      </div>
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="drawer">
    
      <i class="md-icon md-icon--home md-nav__button"></i>
    
    Aqueduct
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://github.com/stablekernel/aqueduct" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      GitHub
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Tutorial
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Tutorial
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../tut/getting-started/" title="1. Getting Started" class="md-nav__link">
      1. Getting Started
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../tut/writing-tests/" title="2. Writing Tests" class="md-nav__link">
      2. Writing Tests
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../tut/executing-queries/" title="3. Executing Database Queries" class="md-nav__link">
      3. Executing Database Queries
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../tut/model-relationships-and-joins/" title="4. Advanced Database Queries" class="md-nav__link">
      4. Advanced Database Queries
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../tut/deploying-and-other-fun-things/" title="5. Deploying" class="md-nav__link">
      5. Deploying
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      HTTP
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        HTTP
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../http/overview/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../http/structure/" title="Application Structure" class="md-nav__link">
      Application Structure
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../http/request_and_response/" title="Request and Response Objects" class="md-nav__link">
      Request and Response Objects
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../http/request_controller/" title="Handling Requests: Fundamentals" class="md-nav__link">
      Handling Requests: Fundamentals
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../http/routing/" title="Routing" class="md-nav__link">
      Routing
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../http/request_sink/" title="Initialization and the RequestSink" class="md-nav__link">
      Initialization and the RequestSink
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../http/http_controller/" title="Handling Requests: HTTPController" class="md-nav__link">
      Handling Requests: HTTPController
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../http/configure/" title="CORS Configuration" class="md-nav__link">
      CORS Configuration
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4" checked>
    
    <label class="md-nav__link" for="nav-4">
      Database/ORM
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Database/ORM
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../overview/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../modeling_data/" title="Modeling Data" class="md-nav__link">
      Modeling Data
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../serialization/" title="Storage, Serialization and Deserialization" class="md-nav__link">
      Storage, Serialization and Deserialization
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../executing_queries/" title="Executing Queries" class="md-nav__link">
      Executing Queries
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="toc">
        Advanced Queries
      </label>
    
    <a href="./" title="Advanced Queries" class="md-nav__link md-nav__link--active">
      Advanced Queries
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#paging-fetched-result-sets" title="Paging Fetched Result Sets" class="md-nav__link">
    Paging Fetched Result Sets
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#filtering-results-of-a-fetch-operation" title="Filtering Results of a Fetch Operation" class="md-nav__link">
    Filtering Results of a Fetch Operation
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#including-relationships-in-a-fetch-aka-joins" title="Including Relationships in a Fetch (aka, Joins)" class="md-nav__link">
    Including Relationships in a Fetch (aka, Joins)
  </a>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../db_tools/" title="Migration and Tooling" class="md-nav__link">
      Migration and Tooling
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../inside_the_db/" title="Inside the DB" class="md-nav__link">
      Inside the DB
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      OAuth 2.0
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        OAuth 2.0
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../auth/overview/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../auth/server/" title="Setting up Authorization" class="md-nav__link">
      Setting up Authorization
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../auth/authorizer/" title="Protected Routes" class="md-nav__link">
      Protected Routes
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../auth/controllers/" title="Issuing Access Tokens" class="md-nav__link">
      Issuing Access Tokens
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../auth/cli/" title="Creating OAuth 2.0 Clients" class="md-nav__link">
      Creating OAuth 2.0 Clients
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../auth/what_is_oauth/" title="What is OAuth 2.0?" class="md-nav__link">
      What is OAuth 2.0?
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      Testing
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        Testing
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../testing/overview/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../testing/harness/" title="Test Harness" class="md-nav__link">
      Test Harness
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../testing/test_client/" title="Writing Tests and the TestClient" class="md-nav__link">
      Writing Tests and the TestClient
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7">
    
    <label class="md-nav__link" for="nav-7">
      Deployment
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-7">
        Deployment
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../deploy/overview/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../deploy/deploy_local/" title="Deploy Locally" class="md-nav__link">
      Deploy Locally
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../deploy/deploy_heroku/" title="Deploy on Heroku" class="md-nav__link">
      Deploy on Heroku
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../deploy/deploy_aws/" title="Deploy on AWS" class="md-nav__link">
      Deploy on AWS
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../deploy/script/" title="Deploying without aqueduct serve" class="md-nav__link">
      Deploying without aqueduct serve
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#paging-fetched-result-sets" title="Paging Fetched Result Sets" class="md-nav__link">
    Paging Fetched Result Sets
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#filtering-results-of-a-fetch-operation" title="Filtering Results of a Fetch Operation" class="md-nav__link">
    Filtering Results of a Fetch Operation
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#including-relationships-in-a-fetch-aka-joins" title="Including Relationships in a Fetch (aka, Joins)" class="md-nav__link">
    Including Relationships in a Fetch (aka, Joins)
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
               
                 <a href="https://github.com/stablekernel/aqueduct/edit/master/docs/db/advanced_queries.md" title="Edit this page" class="md-icon md-content__edit">edit</a>
               
              
                
                <h1 id="advanced-queries-filtering-joins-and-paging">Advanced Queries: Filtering, Joins and Paging</h1>
<h3 id="paging-fetched-result-sets">Paging Fetched Result Sets</h3>
<p>In larger data sets, it may make sense to only return a portion of rows from a database. For example, in a social media application, a user could have thousands of pieces of content they had created over many years. The likely use case for fetching their content would be to grab only the most recent content, and only grab earlier content as necessary. Aqueduct has two mechanisms in <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/Query-class.html">Query&lt;T&gt;</a> for building queries that can fetch a subset of rows within a certain range.</p>
<p>Naive paging can be accomplished using the <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/Query/fetchLimit.html">fetchLimit</a> and <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/Query/offset.html">offset</a> properties of a <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/Query-class.html">Query&lt;T&gt;</a>. For example, if a table contains 100 rows, and you would like to grab 10 at a time, each query would have a value of 10 for its <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/Query/fetchLimit.html">fetchLimit</a>. The first query would have an <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/Query/offset.html">offset</a> of 0, then 10, then 20, and so on. Especially when using <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/Query/sortBy.html">sortBy</a>, this type of paging can be effective. One of the drawbacks to this type of paging is that it can skip or duplicate rows if rows are being added or deleted between fetches.</p>
<p>For example, a table contains 100 rows and you're fetching ten at a time. After two queries, you've fetched 20 total. The next query will fetch rows 21-30 - but before that, a new row is inserted at row 10. That means the old row 10 moves to row 11, row 11 moves to row 12 and so on. Most importantly, row 20 moves to row 21; and the next query will fetch row 21. This row was already fetched in the previous query, so it shows up as a duplicate. (Yes, this needs a diagram.)</p>
<p>A similar issue occurs if a row is deleted from within the first 20 rows after they have been fetched. Row 21 slides down to row 20, so the next query won't fetch that row.</p>
<p>A <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/Query-class.html">Query&lt;T&gt;</a> has a method named <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/Query/pageBy.html">pageBy</a> to better handle paging and avoid the problem of sliding rows. The usage of <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/Query/pageBy.html">pageBy</a> is similar to <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/Query/sortBy.html">sortBy</a>. Here's an example:</p>
<div class="codehilite"><pre><span></span><span class="kd">var</span> <span class="n">firstQuery</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Query</span><span class="o">&lt;</span><span class="n">Post</span><span class="o">&gt;</span><span class="p">()</span>
  <span class="p">..</span><span class="n">pageBy</span><span class="p">((</span><span class="n">p</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">p</span><span class="p">.</span><span class="n">dateCreated</span><span class="p">,</span> <span class="n">QuerySortOrder</span><span class="p">.</span><span class="n">descending</span><span class="p">)</span>
  <span class="p">..</span><span class="n">fetchLimit</span> <span class="o">=</span> <span class="m">10</span><span class="p">;</span>

<span class="kd">var</span> <span class="n">firstQueryResults</span> <span class="o">=</span> <span class="kd">await</span> <span class="n">firstQuery</span><span class="p">.</span><span class="n">fetch</span><span class="p">();</span>

<span class="kd">var</span> <span class="n">oldestPostWeGot</span> <span class="o">=</span> <span class="n">firstQueryResults</span><span class="p">.</span><span class="n">last</span><span class="p">.</span><span class="n">dateCreated</span><span class="p">;</span>
<span class="kd">var</span> <span class="n">nextQuery</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Query</span><span class="o">&lt;</span><span class="n">Post</span><span class="o">&gt;</span><span class="p">()</span>
  <span class="p">..</span><span class="n">pageBy</span><span class="p">((</span><span class="n">p</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">p</span><span class="p">.</span><span class="n">dateCreated</span><span class="p">,</span> <span class="n">QuerySortOrder</span><span class="p">.</span><span class="n">descending</span><span class="p">,</span> <span class="nl">boundingValue:</span> <span class="n">oldestPostWeGot</span><span class="p">)</span>
  <span class="p">..</span><span class="n">fetchLimit</span> <span class="o">=</span> <span class="m">10</span><span class="p">;</span>
</pre></div>


<p>This query would fetch the newest 10 posts. Then, it fetches the next 10 after skipping past all of the ones newer than the oldest post it got in the first result set.</p>
<p>Conceptually, this works by sorting the rows in descending order - larger times are later times and come first, smaller times are earlier times and come later - and then grabs the first 10 from that ordered list. The next query sorts the rows again, but removes any newer than the oldest one in the last query. It takes the first 10 from that shortened list. If you were to search from oldest to newest, you'd reverse the sort order.</p>
<p>When paging, the query must have a <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/Query/fetchLimit.html">fetchLimit</a> - otherwise you're just sorting and returning every row. The <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/Query/pageBy.html">pageBy</a> method takes a closure to identify which property is being used to sort the rows. This closure will be passed an instance of <code>Post</code> and it must return one of its properties. This pattern of using a closure to identify a property like this is common to all of the advanced querying methods. The reason it is done this way is to let the analyzer help you catch errors in query building and the code completion to kick in and write faster code.</p>
<p>The next argument to <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/Query/pageBy.html">pageBy</a> defines the order the rows will be sorted in. Without a bounding value, <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/Query/pageBy.html">pageBy</a> returns rows starting from the beginning of the sorted list of rows. Therefore, when no bounding value is passed, the "first page" of rows is returned. With a bounding value, the query returns rows starting from the first row past the bounding value. The bounding value is not inclusive. For example, consider the following table and a <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/Query/fetchLimit.html">fetchLimit</a> of 2.</p>
<table>
<thead>
<tr>
<th>id</th>
<th>dateCreated</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>Jan 1 -- First Query Starts here</td>
</tr>
<tr>
<td>2</td>
<td>Jan 2</td>
</tr>
<tr>
<td>3</td>
<td>Jan 3</td>
</tr>
<tr>
<td>4</td>
<td>Jan 4</td>
</tr>
</tbody>
</table>
<p>The first query would return <code>Jan 1</code> and <code>Jan 2</code>. In the next query, bounding value is set to <code>Jan 2</code>. The query would start grabbing rows from after Jan 2:</p>
<table>
<thead>
<tr>
<th>id</th>
<th>dateCreated</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>Jan 1</td>
</tr>
<tr>
<td>2</td>
<td>Jan 2</td>
</tr>
<tr>
<td>3</td>
<td>Jan 3 -- Next Query Starts here</td>
</tr>
<tr>
<td>4</td>
<td>Jan 4</td>
</tr>
</tbody>
</table>
<p>In practice, this means passing the property value for the last object in the previous set. This is often accomplished by adding a query parameter to an endpoint that takes in a bounding value. (See <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/ManagedObjectController-class.html">ManagedObjectController&lt;T&gt;</a> as an example.)</p>
<p>A <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/Query/pageBy.html">pageBy</a> query will return an empty list of objects when no more values are left. If the number of objects remaining in the last page are less than the <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/Query/fetchLimit.html">fetchLimit</a>, only those objects will be returned. For example, if there four more objects left and the <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/Query/fetchLimit.html">fetchLimit</a> is 10, the number of objects returned will be four.</p>
<p>You should index properties that will be paged by:</p>
<div class="codehilite"><pre><span></span><span class="err">@</span><span class="n">ManagedColumnAttributes</span><span class="p">(</span><span class="nl">indexed:</span> <span class="kc">true</span><span class="p">)</span>
<span class="kt">int</span> <span class="n">pageableProperty</span><span class="p">;</span>
</pre></div>


<h3 id="filtering-results-of-a-fetch-operation">Filtering Results of a Fetch Operation</h3>
<p>More often than not, fetching every row of a table doesn't make sense. Instead, the desired result is a specific object or set of objects matching some condition. Aqueduct offers two ways to perform this filtering, both of which translate to a SQL <em>where clause</em>.</p>
<p>The first option is the least prohibitive, the most prone to error and the most difficult to maintain: a <code>Query&lt;T&gt;.predicate</code>. A <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/QueryPredicate-class.html">QueryPredicate</a> is a <code>String</code> that is added to the underlying query's where clause. A <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/QueryPredicate-class.html">QueryPredicate</a> has two properties, a format string and a <code>Map&lt;String, dynamic&gt;</code> of parameter values. The <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/APISchemaObject/format.html">format</a> string can (and should) parameterize any input values. Parameters are indicated in the format string using the <code>@</code> token:</p>
<div class="codehilite"><pre><span></span><span class="c1">// Creates a predicate that would only include instances where some column &quot;id&quot; is less than 2</span>
<span class="kd">var</span> <span class="n">predicate</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Predicate</span><span class="p">(</span><span class="s2">&quot;id &lt; @idVariable&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;idVariable&quot;</span> <span class="o">:</span> <span class="m">2</span><span class="p">});</span>
</pre></div>


<p>The text following the <code>@</code> token may contain <code>[A-Za-z0-9_]</code>. The resulting where clause will be formed by replacing each token with the matching key in the parameters map. The value is not transformed in any way, so it must be the appropriate type for the property it is filtering by. If a key is not present in the <code>Map</code>, an exception will be thrown. Extra keys will be ignored.</p>
<p>A raw <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/QueryPredicate-class.html">QueryPredicate</a> like this one suffers from a few issues. First, predicates are <em>database specific</em> that is, after the values from the <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/APIOperation/parameters.html">parameters</a> are added to the <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/APISchemaObject/format.html">format</a> string, the resulting <code>String</code> is evaluated as-is by the underlying database. Perhaps more importantly, there is nothing to verify that the <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/QueryPredicate-class.html">QueryPredicate</a> refers to the appropriate column names or that the data in the <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/APIOperation/parameters.html">parameters</a> is the right type. This can cause chaos when refactoring code, where a simple name change to a property would break a query. This option is primarily intended to be used as a fallback if <code>Query&lt;T&gt;.where</code> is incapable of expressing the desired SQL.</p>
<p>The <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/ManagedSet/where.html">where</a> property of a <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/Query-class.html">Query&lt;T&gt;</a> is a much safer and more elegant way to build a query. The <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/ManagedSet/where.html">where</a> property allows you to assign <em>matchers</em> to the properties of a <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/ManagedObject-class.html">ManagedObject&lt;T&gt;</a>. A matcher applies a condition - like equal to or less than - to the property it is assigned to. (This follows the same Hamcrest matcher style that the Dart test framework uses.)</p>
<p>The <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/ManagedSet/where.html">where</a> property of a <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/Query-class.html">Query&lt;T&gt;</a> has the same properties as the managed object being fetched. For each property of <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/ManagedSet/where.html">where</a> that is assigned a matcher will be added to the SQL where clause. Here's an example of a query that finds a <code>User</code> with an <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/APIOperation/id.html">id</a> equal to 1:</p>
<div class="codehilite"><pre><span></span><span class="kd">var</span> <span class="n">query</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Query</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span><span class="p">()</span>
  <span class="p">..</span><span class="n">where</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">whereEqualTo</span><span class="p">(</span><span class="m">1</span><span class="p">);</span>
</pre></div>


<p>(The generated SQL here would be 'SELECT _user.id, _user.name, ... FROM _user WHERE _user.id = 1'.)</p>
<p>All matchers are created using one of the <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/ManagedSet/where.html">where</a> top-level methods in Aqueduct. Other examples are <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/whereGreaterThan.html">whereGreaterThan</a>, <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/whereBetween.html">whereBetween</a>, and <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/whereIn.html">whereIn</a>. Every matcher set on a <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/ManagedSet/where.html">where</a> is combined using logical 'and'. In other words, the following query will find all users whose <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/APIContact/name.html">name</a> is "Bob" <em>and</em> <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/APIContact/email.html">email</a> is not null:</p>
<div class="codehilite"><pre><span></span><span class="kd">var</span> <span class="n">query</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Query</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span><span class="p">()</span>
  <span class="p">..</span><span class="n">where</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">whereEqualTo</span><span class="p">(</span><span class="s2">&quot;Bob&quot;</span><span class="p">)</span>
  <span class="p">..</span><span class="n">where</span><span class="p">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">whereNotNull</span><span class="p">;</span>
</pre></div>


<p>There are a number of <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/ManagedSet/where.html">where</a> methods for different logic and string comparisons, see the API reference for more.</p>
<p>Relationship properties can be have matchers, too. For example, the following query will fetch all parents who have children that are less than 10 years old:</p>
<div class="codehilite"><pre><span></span><span class="kd">var</span> <span class="n">query</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Query</span><span class="o">&lt;</span><span class="n">Parent</span><span class="o">&gt;</span><span class="p">()</span>
  <span class="p">..</span><span class="n">where</span><span class="p">.</span><span class="n">children</span><span class="p">.</span><span class="n">haveAtLeastOneWhere</span><span class="p">.</span><span class="n">age</span> <span class="o">=</span> <span class="n">whereLessThan</span><span class="p">(</span><span class="m">10</span><span class="p">);</span>
</pre></div>


<p>When building <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/ManagedSet/where.html">where</a> with relationship properties, there are some important things to understand. First, the values for any relationship properties are not returned in the results. In the previous query, that means that a list of <code>Parent</code>s would be returned - but their <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/Logger/children.html">children</a> property wouldn't be populated. (To actually include relationship values, the next section talks about <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/Query/joinOne.html">joinOne</a> and <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/Query/joinMany.html">joinMany</a>.)</p>
<p>Most <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/ManagedSet/where.html">where</a>s that match on relationship properties will trigger a SQL join. This is a more expensive query than fetching from a single row. The only time a relationship matcher doesn't incur a SQL join is when matching the value of a foreign key column. That is, a belongs-to relationship property where we're only checking the primary key of the related object. There are two ways of doing this:</p>
<div class="codehilite"><pre><span></span><span class="kd">var</span> <span class="n">preferredQuery</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Query</span><span class="o">&lt;</span><span class="n">Child</span><span class="o">&gt;</span><span class="p">()</span>
  <span class="p">..</span><span class="n">where</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">whereRelatedByValue</span><span class="p">(</span><span class="m">23</span><span class="p">);</span>

<span class="kd">var</span> <span class="n">sameQuery</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Query</span><span class="o">&lt;</span><span class="n">Child</span><span class="o">&gt;</span><span class="p">()</span>
  <span class="p">..</span><span class="n">where</span><span class="p">.</span><span class="n">parent</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">whereEqualTo</span><span class="p">(</span><span class="m">23</span><span class="p">);</span>
</pre></div>


<p>The first query is preferred because it's clear to the reader what's happening. A query can be filtered by whether or not it has a value for its relationships. For example, the following queries return people with and without children:</p>
<div class="codehilite"><pre><span></span><span class="kd">var</span> <span class="n">peopleWithoutChildren</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Query</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;</span><span class="p">()</span>
  <span class="p">..</span><span class="n">where</span><span class="p">.</span><span class="n">children</span> <span class="o">=</span> <span class="n">whereNull</span><span class="p">;</span>

<span class="kd">var</span> <span class="n">peopleWithChildren</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Query</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;</span><span class="p">()</span>
  <span class="p">..</span><span class="n">where</span><span class="p">.</span><span class="n">children</span> <span class="o">=</span> <span class="n">whereNotNull</span><span class="p">;</span>
</pre></div>


<p>The only matchers that can be applied directly to a relationship property are the three shown in these examples: <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/whereRelatedByValue.html">whereRelatedByValue</a>, <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/whereNull-constant.html">whereNull</a> and <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/whereNotNull-constant.html">whereNotNull</a>. Properties of a relationship property, i.e. <code>where.parent.age = whereGreaterThan(40)</code>, don't have these restrictions.</p>
<p>You can access relationship properties of relationships, too:</p>
<div class="codehilite"><pre><span></span><span class="kd">var</span> <span class="n">childrenWithDoctorParents</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Query</span><span class="o">&lt;</span><span class="n">Child</span><span class="o">&gt;</span><span class="p">()</span>
  <span class="p">..</span><span class="n">where</span><span class="p">.</span><span class="n">parent</span><span class="p">.</span><span class="n">job</span><span class="p">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">whereEqualTo</span><span class="p">(</span><span class="s2">&quot;Doctor&quot;</span><span class="p">);</span>
</pre></div>


<p>You can match belongs to or has one relationships by just assigning matchers to their properties. A has-many relationship, however, is a <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/ManagedSet-class.html">ManagedSet&lt;T&gt;</a>. When matching on properties of a has-many relationship, you have to access their <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/ManagedSet/haveAtLeastOneWhere.html">haveAtLeastOneWhere</a> property. The type of this property is the type of object in the <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/ManagedSet-class.html">ManagedSet&lt;T&gt;</a>, so it will have the properties of that type. To repeat the example above:</p>
<div class="codehilite"><pre><span></span><span class="kd">var</span> <span class="n">query</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Query</span><span class="o">&lt;</span><span class="n">Parent</span><span class="o">&gt;</span><span class="p">()</span>
  <span class="p">..</span><span class="n">where</span><span class="p">.</span><span class="n">children</span><span class="p">.</span><span class="n">haveAtLeastOneWhere</span><span class="p">.</span><span class="n">age</span> <span class="o">=</span> <span class="n">whereLessThan</span><span class="p">(</span><span class="m">10</span><span class="p">);</span>
</pre></div>


<p>The name here is important. The filter is applied to the returned <code>Parent</code>s - if a parent doesn't have a child that is younger than 10, it will be removed from the result set. If just one of a parent's children is less than 10, it will be included. There is currently no support for checking the number of objects in the relationship.</p>
<h3 id="including-relationships-in-a-fetch-aka-joins">Including Relationships in a Fetch (aka, Joins)</h3>
<p>A <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/Query-class.html">Query&lt;T&gt;</a> can also fetch relationship properties. This allows queries to fetch entire model graphs and reduces the number of round-trips to a database. (This type of fetch will execute a SQL LEFT OUTER JOIN.)</p>
<p>By default, relationship properties are not fetched in a query and therefore aren't included in an object's <code>asMap()</code>. For example, consider the following two <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/ManagedObject-class.html">ManagedObject&lt;T&gt;</a>s, where a <code>User</code> has-many <code>Task</code>s:</p>
<div class="codehilite"><pre><span></span><span class="kd">class</span> <span class="nc">User</span> <span class="kd">extends</span> <span class="n">ManagedObject</span><span class="o">&lt;</span><span class="n">_User</span><span class="o">&gt;</span> <span class="kd">implements</span> <span class="n">_User</span> <span class="p">{}</span>
<span class="kd">class</span> <span class="nc">_User</span> <span class="p">{</span>
  <span class="err">@</span><span class="n">managedPrimaryKey</span> <span class="kt">int</span> <span class="n">id</span><span class="p">;</span>

  <span class="kt">String</span> <span class="n">name</span><span class="p">;</span>
  <span class="n">ManagedSet</span><span class="o">&lt;</span><span class="n">Task</span><span class="o">&gt;</span> <span class="n">tasks</span><span class="p">;</span>  
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">Task</span> <span class="kd">extends</span> <span class="n">ManagedObject</span><span class="o">&lt;</span><span class="n">_Task</span><span class="o">&gt;</span> <span class="kd">implements</span> <span class="n">_Task</span> <span class="p">{}</span>
<span class="kd">class</span> <span class="nc">_Task</span> <span class="p">{</span>
  <span class="err">@</span><span class="n">managedPrimaryKey</span> <span class="kt">int</span> <span class="n">id</span><span class="p">;</span>

  <span class="err">@</span><span class="n">ManagedColumnAttributes</span><span class="p">(</span><span class="err">#</span><span class="n">tasks</span><span class="p">)</span>
  <span class="n">User</span> <span class="n">user</span><span class="p">;</span>

  <span class="kt">String</span> <span class="n">contents</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<p>A <code>Query&lt;User&gt;</code> will fetch the <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/APIContact/name.html">name</a> and <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/APIOperation/id.html">id</a> of each <code>User</code>. A <code>User</code>'s <code>tasks</code> are not fetched, so the data returned looks like this:</p>
<div class="codehilite"><pre><span></span><span class="kd">var</span> <span class="n">q</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Query</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span><span class="p">();</span>
<span class="kd">var</span> <span class="n">users</span> <span class="o">=</span> <span class="kd">await</span> <span class="n">q</span><span class="p">.</span><span class="n">fetch</span><span class="p">();</span>

<span class="n">users</span><span class="p">.</span><span class="n">first</span><span class="p">.</span><span class="n">asMap</span><span class="p">()</span> <span class="o">==</span> <span class="p">{</span>
  <span class="s2">&quot;id&quot;</span><span class="o">:</span> <span class="m">1</span><span class="p">,</span>
  <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;Bob&quot;</span>
<span class="p">};</span> <span class="c1">// yup</span>
</pre></div>


<p>The method <code>joinMany()</code> will tell a <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/Query-class.html">Query&lt;T&gt;</a> to also include a particular has-many relationship, here, a user's <code>tasks</code>:</p>
<div class="codehilite"><pre><span></span><span class="kd">var</span> <span class="n">q</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Query</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span><span class="p">()</span>
  <span class="p">..</span><span class="n">joinMany</span><span class="p">((</span><span class="n">u</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">u</span><span class="p">.</span><span class="n">tasks</span><span class="p">);</span>
<span class="kd">var</span> <span class="n">users</span> <span class="o">=</span> <span class="kd">await</span> <span class="n">q</span><span class="p">.</span><span class="n">fetch</span><span class="p">();</span>

<span class="n">users</span><span class="p">.</span><span class="n">first</span><span class="p">.</span><span class="n">asMap</span><span class="p">()</span> <span class="o">==</span> <span class="p">{</span>
  <span class="s2">&quot;id&quot;</span><span class="o">:</span> <span class="m">1</span><span class="p">,</span>
  <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;Bob&quot;</span><span class="p">,</span>
  <span class="s2">&quot;tasks&quot;</span><span class="o">:</span> <span class="p">[</span>
      <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="o">:</span> <span class="m">1</span><span class="p">,</span> <span class="s2">&quot;contents&quot;</span><span class="o">:</span> <span class="s2">&quot;Take out trash&quot;</span><span class="p">,</span> <span class="s2">&quot;user&quot;</span> <span class="o">:</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="o">:</span> <span class="m">1</span><span class="p">}},</span>
      <span class="p">...</span>
  <span class="p">]</span>
<span class="p">};</span> <span class="c1">// yup</span>
</pre></div>


<p>Notice that the <code>tasks</code> are in fact included in this query. The argument to <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/Query/joinMany.html">joinMany</a> is a closure that must return a <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/ManagedSet-class.html">ManagedSet&lt;T&gt;</a> property of the object being queried. The values for each task is the default set of properties as though a <code>Query&lt;Task&gt;</code> was executed. However, this can be modified.</p>
<p>The method <code>joinMany()</code> actually returns a new <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/Query-class.html">Query&lt;T&gt;</a>, where <code>T</code> is the type of object in the relationship property. That is, the above code could also be written as such:</p>
<div class="codehilite"><pre><span></span><span class="kd">var</span> <span class="n">q</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Query</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span><span class="p">();</span>

<span class="c1">// type annotation added for clarity</span>
<span class="n">Query</span><span class="o">&lt;</span><span class="n">Task</span><span class="o">&gt;</span> <span class="n">taskSubQuery</span> <span class="o">=</span> <span class="n">q</span><span class="p">.</span><span class="n">joinMany</span><span class="p">((</span><span class="n">u</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">u</span><span class="p">.</span><span class="n">tasks</span><span class="p">);</span>
</pre></div>


<p>Just like any other <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/Query-class.html">Query&lt;T&gt;</a>, the set of returning properties can be modified through <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/Query/returningProperties.html">returningProperties</a>:</p>
<div class="codehilite"><pre><span></span><span class="kd">var</span> <span class="n">q</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Query</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span><span class="p">()</span>
  <span class="p">..</span><span class="n">returningProperties</span><span class="p">((</span><span class="n">u</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="n">u</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">name</span><span class="p">]);</span>

<span class="n">q</span><span class="p">.</span><span class="n">joinMany</span><span class="p">((</span><span class="n">u</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">u</span><span class="p">.</span><span class="n">tasks</span><span class="p">)</span>  
  <span class="p">..</span><span class="n">returningProperties</span><span class="p">((</span><span class="n">t</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="n">t</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">t</span><span class="p">.</span><span class="n">contents</span><span class="p">]);</span>
</pre></div>


<p>When joining on a has-one or a belongs-to relationship, use <code>joinOne()</code> instead of <code>joinMany()</code>:</p>
<div class="codehilite"><pre><span></span><span class="kd">var</span> <span class="n">q</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Query</span><span class="o">&lt;</span><span class="n">Task</span><span class="o">&gt;</span><span class="p">()</span>
  <span class="p">..</span><span class="n">joinOne</span><span class="p">((</span><span class="n">t</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">t</span><span class="p">.</span><span class="n">user</span><span class="p">);</span>
<span class="kd">var</span> <span class="n">results</span> <span class="o">=</span> <span class="kd">await</span> <span class="n">q</span><span class="p">.</span><span class="n">fetch</span><span class="p">();</span>

<span class="n">results</span><span class="p">.</span><span class="n">first</span><span class="p">.</span><span class="n">asMap</span><span class="p">()</span> <span class="o">==</span> <span class="p">{</span>
  <span class="s2">&quot;id&quot;</span><span class="o">:</span> <span class="m">1</span><span class="p">,</span>
  <span class="s2">&quot;contents&quot;</span><span class="o">:</span> <span class="s2">&quot;Take out trash&quot;</span><span class="p">,</span>
  <span class="s2">&quot;user&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">&quot;id&quot;</span><span class="o">:</span> <span class="m">1</span><span class="p">,</span>
    <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;Bob&quot;</span>
  <span class="p">}</span>
<span class="p">};</span> <span class="c1">// yup</span>
</pre></div>


<p>Notice that the results of this query include all of the details for a <code>Task</code>'s <code>user</code> - not just its <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/APIOperation/id.html">id</a>.</p>
<p>A subquery created through <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/Query/joinOne.html">joinOne</a> or <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/Query/joinMany.html">joinMany</a> can also be filtered through its <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/ManagedSet/where.html">where</a>. For example, the following query would return user's named 'Bob' and their overdue tasks only:</p>
<div class="codehilite"><pre><span></span><span class="kd">var</span> <span class="n">q</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Query</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span><span class="p">()</span>
  <span class="p">..</span><span class="n">where</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">whereEquals</span><span class="p">(</span><span class="s2">&quot;Bob&quot;</span><span class="p">);</span>

<span class="n">q</span><span class="p">.</span><span class="n">joinMany</span><span class="p">((</span><span class="n">u</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">u</span><span class="p">.</span><span class="n">tasks</span><span class="p">)</span>  
  <span class="p">..</span><span class="n">where</span><span class="p">.</span><span class="n">overdue</span> <span class="o">=</span> <span class="n">whereEqualTo</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
</pre></div>


<p>Note that the <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/ManagedSet/where.html">where</a> property on the subquery is an instance of <code>Task</code>, whereas <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/ManagedSet/where.html">where</a> on the <code>User</code> query is <code>User</code>.</p>
<p>More than one join can be applied to a query, and subqueries can be nested. So, this is all valid, assuming the relationship properties exist:</p>
<div class="codehilite"><pre><span></span><span class="kd">var</span> <span class="n">q</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Query</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span><span class="p">()</span>
  <span class="p">..</span><span class="n">joinOne</span><span class="p">((</span><span class="n">u</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">u</span><span class="p">.</span><span class="n">address</span><span class="p">);</span>

<span class="n">q</span><span class="p">.</span><span class="n">joinMany</span><span class="p">((</span><span class="n">u</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">u</span><span class="p">.</span><span class="n">tasks</span><span class="p">)</span>
  <span class="p">..</span><span class="n">joinOne</span><span class="p">((</span><span class="n">u</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">u</span><span class="p">.</span><span class="n">location</span><span class="p">);</span>
</pre></div>


<p>This would fetch all users, their addresses, all of their tasks, and the location for each of their tasks. You'd get a nice sized tree of objects here.</p>
<p>It's important to understand how objects are filtered when using <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/ManagedSet/where.html">where</a> and subqueries. Matchers applied to the top-level query will filter out those types of objects. A <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/ManagedSet/where.html">where</a> on a subquery has no impact on the number of objects returned at the top-level. Let's say there were 10 total users, each with 10 total tasks. The following query would always return 10 user objects, but each user's <code>tasks</code> wouldn't necessarily contain all 10:</p>
<div class="codehilite"><pre><span></span><span class="kd">var</span> <span class="n">q</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Query</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span><span class="p">();</span>

<span class="n">q</span><span class="p">.</span><span class="n">joinMany</span><span class="p">((</span><span class="n">u</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">u</span><span class="p">.</span><span class="n">tasks</span><span class="p">)</span>
  <span class="p">..</span><span class="n">where</span><span class="p">.</span><span class="n">overdue</span> <span class="o">=</span> <span class="n">whereEqualTo</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
</pre></div>


<p>However, the following query would return less than 10 users, but for each user returned, they would have all 10 of their tasks:</p>
<div class="codehilite"><pre><span></span><span class="kd">var</span> <span class="n">q</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Query</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span><span class="p">()</span>
  <span class="p">..</span><span class="n">where</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">whereEqualTo</span><span class="p">(</span><span class="s2">&quot;Bob&quot;</span><span class="p">)</span>
  <span class="p">..</span><span class="n">joinMany</span><span class="p">((</span><span class="n">u</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">u</span><span class="p">.</span><span class="n">tasks</span><span class="p">);</span>
</pre></div>


<p>Note that a query will always fetch the primary key of all objects, even if it is omitted in <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/Query/returningProperties.html">returningProperties</a>.</p>
              
              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../executing_queries/" title="Executing Queries" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Executing Queries
              </span>
            </div>
          </a>
        
        
          <a href="../db_tools/" title="Migration and Tooling" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Migration and Tooling
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Built by stable|kernel
          </div>
        
        powered by
        <a href="http://www.mkdocs.org" title="MkDocs">MkDocs</a>
        and
        <a href="http://squidfunk.github.io/mkdocs-material/" title="Material for MkDocs">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application-30ac6a1727.js"></script>
      <script>app.initialize({url:{base:"../.."}})</script>
      
    
    
      
      <script>!function(e,t,a,n,o,c,i){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,c=t.createElement(a),i=t.getElementsByTagName(a)[0],c.async=1,c.src=n,i.parentNode.insertBefore(c,i)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-41269877-2","aqueduct.io"),ga("set","anonymizeIp",!0),ga("send","pageview");var links=document.getElementsByTagName("a");Array.prototype.map.call(links,function(e){e.host!=document.location.host&&e.addEventListener("click",function(){var t=e.getAttribute("data-md-action")||"follow";ga("send","event","outbound",t,e.href)})});var query=document.forms.search.query;query.addEventListener("blur",function(){if(this.value){var e=document.location.pathname;ga("send","pageview",e+"?q="+this.value)}})</script>
      
    
  </body>
</html>