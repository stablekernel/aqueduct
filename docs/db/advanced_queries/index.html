
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Documentation for Aqueduct, a Dart server-side framework.">
      
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-7.0.6">
    
    
      
        <title>Advanced Queries - Aqueduct</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.2c0c5eaf.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.7fa14f5b.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
      <link rel="stylesheet" href="../../style/css/override.css">
    
    
      
        
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-41269877-2","aqueduct.io"),ga("set","anonymizeIp",!0),ga("send","pageview"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){var e;this.value&&(e=document.location.pathname,ga("send","pageview",e+"?q="+this.value))}),"undefined"!=typeof location$&&location$.subscribe(function(e){ga("send","pageview",e.pathname)})})</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
      
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#advanced-queries-filtering-joins-paging-and-reduce" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
        <aside class="md-announce">
          <div class="md-announce__inner md-grid md-typeset">
            
We've made the difficult decision to no longer support Aqueduct. Read the why behind our decision and how the sunsetting of Aqueduct might impact your projects
<a href="https://stablekernel.com/article/announcing-the-sunsetting-of-aqueduct-our-open-source-server-side-framework-in-googles-dart/">here</a>.

          </div>
        </aside>
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Aqueduct" class="md-header__button md-logo" aria-label="Aqueduct" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Aqueduct
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Advanced Queries
            
          </span>
        </div>
      </div>
    </div>
    <div class="md-header__options">
      
    </div>
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        
<a href="https://github.com/stablekernel/aqueduct/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Aqueduct" class="md-nav__button md-logo" aria-label="Aqueduct" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Aqueduct
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/stablekernel/aqueduct/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../core_concepts/" class="md-nav__link">
        Core Concepts
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../getting_started/" class="md-nav__link">
        Getting Started
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../tour/" class="md-nav__link">
        Tour
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../best_practices/" class="md-nav__link">
        Best Practices
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../intellij/" class="md-nav__link">
        IntelliJ IDEA Templates
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7" type="checkbox" id="__nav_7" >
      
      <label class="md-nav__link" for="__nav_7">
        Tutorial
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Tutorial" data-md-level="1">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          Tutorial
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../tut/getting-started/" class="md-nav__link">
        1. Getting Started
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../tut/executing-queries/" class="md-nav__link">
        2. Reading from a Database
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../tut/storing-data/" class="md-nav__link">
        3. Storing Data in a Database
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../tut/writing-tests/" class="md-nav__link">
        4. Configuration and Testing
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../tut/oauth2/" class="md-nav__link">
        5. Authentication and Authorization
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_8" type="checkbox" id="__nav_8" >
      
      <label class="md-nav__link" for="__nav_8">
        Snippets
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Snippets" data-md-level="1">
        <label class="md-nav__title" for="__nav_8">
          <span class="md-nav__icon md-icon"></span>
          Snippets
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../snippets/" class="md-nav__link">
        Overview
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../snippets/http/" class="md-nav__link">
        HTTP
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../snippets/orm/" class="md-nav__link">
        ORM
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../snippets/auth/" class="md-nav__link">
        Authentication and Authorization
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../snippets/test/" class="md-nav__link">
        Testing
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_9" type="checkbox" id="__nav_9" >
      
      <label class="md-nav__link" for="__nav_9">
        Guide: Application Configuration and Behavior
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Guide: Application Configuration and Behavior" data-md-level="1">
        <label class="md-nav__title" for="__nav_9">
          <span class="md-nav__icon md-icon"></span>
          Guide: Application Configuration and Behavior
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../application/" class="md-nav__link">
        Overview
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../application/channel/" class="md-nav__link">
        Starting and Stopping Applications
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../application/configure/" class="md-nav__link">
        Configuring an Application and its Environment
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../application/structure/" class="md-nav__link">
        Application and Project Structure
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../application/threading/" class="md-nav__link">
        Multi-threading
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_10" type="checkbox" id="__nav_10" >
      
      <label class="md-nav__link" for="__nav_10">
        Guide: Handling HTTP Requests
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Guide: Handling HTTP Requests" data-md-level="1">
        <label class="md-nav__title" for="__nav_10">
          <span class="md-nav__icon md-icon"></span>
          Guide: Handling HTTP Requests
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../http/" class="md-nav__link">
        Overview
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../http/controller/" class="md-nav__link">
        Handling Requests and Sending Response
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../http/request_and_response/" class="md-nav__link">
        Serializing Request and Response Bodies
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../http/routing/" class="md-nav__link">
        Routing
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../http/resource_controller/" class="md-nav__link">
        Request Binding with Resource Controllers
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../http/serving_files/" class="md-nav__link">
        Serving Files and Caching
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../http/websockets/" class="md-nav__link">
        Websockets
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../http/file_upload/" class="md-nav__link">
        Uploading Files
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_11" type="checkbox" id="__nav_11" checked>
      
      <label class="md-nav__link" for="__nav_11">
        Guide: Databases and ORM
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Guide: Databases and ORM" data-md-level="1">
        <label class="md-nav__title" for="__nav_11">
          <span class="md-nav__icon md-icon"></span>
          Guide: Databases and ORM
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        Overview
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../connecting/" class="md-nav__link">
        Connecting to a Database
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../modeling_data/" class="md-nav__link">
        Modeling Data and Relationships
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../serialization/" class="md-nav__link">
        Serialization and Deserialization
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../executing_queries/" class="md-nav__link">
        Basic Queries
      </a>
    </li>
  

          
            
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Advanced Queries
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Advanced Queries
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#paging-fetched-result-sets" class="md-nav__link">
    Paging Fetched Result Sets
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#filtering-results-of-a-fetch-operation" class="md-nav__link">
    Filtering Results of a Fetch Operation
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#including-relationships-in-a-fetch-aka-joins" class="md-nav__link">
    Including Relationships in a Fetch (aka, Joins)
  </a>
  
    <nav class="md-nav" aria-label="Including Relationships in a Fetch (aka, Joins)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#configuring-join-queries" class="md-nav__link">
    Configuring Join Queries
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#filtering-objects-by-their-relationships" class="md-nav__link">
    Filtering Objects by Their Relationships
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#multiple-joins" class="md-nav__link">
    Multiple Joins
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#reduce-functions-aka-aggregate-functions" class="md-nav__link">
    Reduce Functions (aka, Aggregate Functions)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fallbacks" class="md-nav__link">
    Fallbacks
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../transactions/" class="md-nav__link">
        Transactions
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../validations/" class="md-nav__link">
        Validations
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../db_tools/" class="md-nav__link">
        Migration and Tooling
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../json_columns/" class="md-nav__link">
        JSON Document Storage
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_12" type="checkbox" id="__nav_12" >
      
      <label class="md-nav__link" for="__nav_12">
        Guide: Authorization and OAuth 2.0
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Guide: Authorization and OAuth 2.0" data-md-level="1">
        <label class="md-nav__title" for="__nav_12">
          <span class="md-nav__icon md-icon"></span>
          Guide: Authorization and OAuth 2.0
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../auth/" class="md-nav__link">
        Overview
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../auth/server/" class="md-nav__link">
        Setting up Authorization
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../auth/authorizer/" class="md-nav__link">
        Protecting Routes
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../auth/controllers/" class="md-nav__link">
        Issuing Access Tokens
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../auth/cli/" class="md-nav__link">
        Managing OAuth 2.0 Clients
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../auth/auth_scopes/" class="md-nav__link">
        OAuth 2.0 Scoping
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../auth/what_is_oauth/" class="md-nav__link">
        What is OAuth 2.0?
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_13" type="checkbox" id="__nav_13" >
      
      <label class="md-nav__link" for="__nav_13">
        Guide: Development and Testing
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Guide: Development and Testing" data-md-level="1">
        <label class="md-nav__title" for="__nav_13">
          <span class="md-nav__icon md-icon"></span>
          Guide: Development and Testing
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../testing/" class="md-nav__link">
        Overview
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../testing/tests/" class="md-nav__link">
        Writing Tests
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../testing/mixins/" class="md-nav__link">
        Testing with the ORM and OAuth 2.0
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../testing/debugger/" class="md-nav__link">
        Using the Debugger
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../testing/clients/" class="md-nav__link">
        Developing Client Applications
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../testing/mock/" class="md-nav__link">
        Mocking Services
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_14" type="checkbox" id="__nav_14" >
      
      <label class="md-nav__link" for="__nav_14">
        Guide: OpenAPI Documentation
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Guide: OpenAPI Documentation" data-md-level="1">
        <label class="md-nav__title" for="__nav_14">
          <span class="md-nav__icon md-icon"></span>
          Guide: OpenAPI Documentation
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../openapi/" class="md-nav__link">
        Overview
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../openapi/cli/" class="md-nav__link">
        Creating an OpenAPI Document
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../openapi/components/" class="md-nav__link">
        Documenting Components
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../openapi/endpoint/" class="md-nav__link">
        Documenting Endpoint Controllers
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../openapi/middleware/" class="md-nav__link">
        Documenting Middleware Controllers
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_15" type="checkbox" id="__nav_15" >
      
      <label class="md-nav__link" for="__nav_15">
        Guide: Command-line Tooling
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Guide: Command-line Tooling" data-md-level="1">
        <label class="md-nav__title" for="__nav_15">
          <span class="md-nav__icon md-icon"></span>
          Guide: Command-line Tooling
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../cli/" class="md-nav__link">
        Overview
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../cli/create/" class="md-nav__link">
        Creating Applications
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../cli/running/" class="md-nav__link">
        Running Applications
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../cli/document/" class="md-nav__link">
        Generating an OpenAPI/Swagger Specification
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_16" type="checkbox" id="__nav_16" >
      
      <label class="md-nav__link" for="__nav_16">
        Guide: Deployment
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Guide: Deployment" data-md-level="1">
        <label class="md-nav__title" for="__nav_16">
          <span class="md-nav__icon md-icon"></span>
          Guide: Deployment
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../deploy/" class="md-nav__link">
        Overview
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../deploy/build/" class="md-nav__link">
        Creating an Aqueduct Executable
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../deploy/deploy_local/" class="md-nav__link">
        Deploy Locally (VM)
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../deploy/deploy_docker/" class="md-nav__link">
        Deploying with Docker and Kubernetes (VM)
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../deploy/deploy_heroku/" class="md-nav__link">
        Deploy on Heroku (VM)
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../deploy/deploy_aws/" class="md-nav__link">
        Deploy on AWS (VM)
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../deploy/script/" class="md-nav__link">
        Deploying without aqueduct serve (VM)
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#paging-fetched-result-sets" class="md-nav__link">
    Paging Fetched Result Sets
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#filtering-results-of-a-fetch-operation" class="md-nav__link">
    Filtering Results of a Fetch Operation
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#including-relationships-in-a-fetch-aka-joins" class="md-nav__link">
    Including Relationships in a Fetch (aka, Joins)
  </a>
  
    <nav class="md-nav" aria-label="Including Relationships in a Fetch (aka, Joins)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#configuring-join-queries" class="md-nav__link">
    Configuring Join Queries
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#filtering-objects-by-their-relationships" class="md-nav__link">
    Filtering Objects by Their Relationships
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#multiple-joins" class="md-nav__link">
    Multiple Joins
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#reduce-functions-aka-aggregate-functions" class="md-nav__link">
    Reduce Functions (aka, Aggregate Functions)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fallbacks" class="md-nav__link">
    Fallbacks
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/stablekernel/aqueduct/edit/docs/source/source/docs/db/advanced_queries.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <h1 id="advanced-queries-filtering-joins-paging-and-reduce">Advanced Queries: Filtering, Joins, Paging and Reduce</h1>
<h2 id="paging-fetched-result-sets">Paging Fetched Result Sets</h2>
<p>The rows from a table can be sorted and fetched in contiguous chunks. This sorting can occur on most properties. For example, in a social media application, a user could have thousands of pieces of content they had created over many years. The likely use case for fetching their content would be to grab only the most recent content, and only grab earlier content as necessary. Aqueduct has two mechanisms in <code>Query&lt;T&gt;</code> for building queries that can fetch a subset of rows within a certain range.</p>
<p>Naive paging can be accomplished using the <code>fetchLimit</code> and <code>offset</code> properties of a <code>Query&lt;T&gt;</code>. For example, if a table contains 100 rows, and you would like to grab 10 at a time, each query would have a value of 10 for its <code>fetchLimit</code>. The first query would have an <code>offset</code> of 0, then 10, then 20, and so on. Especially when using <code>sortBy</code>, this type of paging can be effective. One of the drawbacks to this type of paging is that it can skip or duplicate rows if rows are being added or deleted between fetches.</p>
<p><img alt="Paging Error" src="../../img/paging.png" /></p>
<p>For example, consider the seven objects above that are ordered by time. If we page by two objects at a time (<code>fetchLimit=2</code>) starting at the first item (<code>offset=0</code>), our first result set is the first two objects. The next page is the original offset plus the same limit - we grab the next two rows. But before the next page is fetched, a new object is inserted and its at an index that we already fetched. The next page would return <code>3:00pm</code> again. A similar problem occurs if a row is deleted when paging in this way.</p>
<p>It is really annoying for client applications to have to check for and merge duplicates. Another paging technique that doesn't suffer from this problem relies on the client sending a value from the last object in the previous page, instead of an offset. So in the above example, instead of asking for offset 2 in the second query, it'd send the value <code>1:30pm</code>. The query filters out rows with a value less than the one it was sent, orders the remaining rows and then fetches the newest from the top.</p>
<p><code>Query.pageBy</code> uses this technique. Its usage is similar to <code>sortBy</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="kd">var</span> <span class="n">firstQuery</span> <span class="o">=</span> <span class="n">Query</span><span class="o">&lt;</span><span class="n">Post</span><span class="o">&gt;</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
  <span class="p">..</span><span class="n">pageBy</span><span class="p">((</span><span class="n">p</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">p</span><span class="p">.</span><span class="n">dateCreated</span><span class="p">,</span> <span class="n">QuerySortOrder</span><span class="p">.</span><span class="n">descending</span><span class="p">)</span>
  <span class="p">..</span><span class="n">fetchLimit</span> <span class="o">=</span> <span class="m">10</span><span class="p">;</span>

<span class="kd">var</span> <span class="n">firstQueryResults</span> <span class="o">=</span> <span class="kd">await</span> <span class="n">firstQuery</span><span class="p">.</span><span class="n">fetch</span><span class="p">();</span>

<span class="kd">var</span> <span class="n">oldestPostWeGot</span> <span class="o">=</span> <span class="n">firstQueryResults</span><span class="p">.</span><span class="n">last</span><span class="p">.</span><span class="n">dateCreated</span><span class="p">;</span>
<span class="kd">var</span> <span class="n">nextQuery</span> <span class="o">=</span> <span class="n">Query</span><span class="o">&lt;</span><span class="n">Post</span><span class="o">&gt;</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
  <span class="p">..</span><span class="n">pageBy</span><span class="p">((</span><span class="n">p</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">p</span><span class="p">.</span><span class="n">dateCreated</span><span class="p">,</span> <span class="n">QuerySortOrder</span><span class="p">.</span><span class="n">descending</span><span class="p">,</span> <span class="nl">boundingValue:</span> <span class="n">oldestPostWeGot</span><span class="p">)</span>
  <span class="p">..</span><span class="n">fetchLimit</span> <span class="o">=</span> <span class="m">10</span><span class="p">;</span>
</code></pre></div>

<p>This query would fetch the newest 10 posts. Then, it fetches the next 10 after skipping past all of the ones newer than the oldest post it got in the first result set.</p>
<p>When paging, the query must have a <code>fetchLimit</code> - otherwise you're just sorting and returning every row. You identify which property to page on by using a property selector. The second argument to <code>pageBy</code> defines the order the rows will be sorted in.</p>
<p>When you first start paging, you don't have any results yet, so you can't specify a value from the last result set. In this case, the <code>boundingValue</code> of <code>pageBy</code> is null - meaning start from the beginning. Once the first set has been fetched, the <code>boundingValue</code> is the value of the paging property in the last object returned.</p>
<p>This is often accomplished by adding a query parameter to an endpoint that takes in a bounding value. (See <code>ManagedObjectController&lt;T&gt;</code> as an example.)</p>
<p>A <code>pageBy</code> query will return an empty list of objects when no more values are left. If the number of objects remaining in the last page are less than the <code>fetchLimit</code>, only those objects will be returned. For example, if there four more objects left and the <code>fetchLimit</code> is 10, the number of objects returned will be four.</p>
<p>You should index properties that will be paged by:</p>
<div class="codehilite"><pre><span></span><code><span class="nd">@Column</span><span class="p">(</span><span class="nl">indexed:</span> <span class="kc">true</span><span class="p">)</span>
<span class="kt">int</span> <span class="n">pageableProperty</span><span class="p">;</span>
</code></pre></div>

<h2 id="filtering-results-of-a-fetch-operation">Filtering Results of a Fetch Operation</h2>
<p>Fetching every row of a table usually doesn't make sense. Instead, we want a specific object or a set of objects matching some criteria.</p>
<p>A <code>Query</code>'s <code>where</code> method is a safe and elegant way to add this criteria to a query. This method allows you to assign boolean expressions to the properties of the object being queried. Each expression is added to the WHERE clause of the generated SQL query. Here's an example of a query that finds a <code>User</code> with an <code>id</code> equal to 1:</p>
<div class="codehilite"><pre><span></span><code><span class="kd">var</span> <span class="n">query</span> <span class="o">=</span> <span class="n">Query</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
  <span class="p">..</span><span class="n">where</span><span class="p">((</span><span class="n">u</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">u</span><span class="p">.</span><span class="n">id</span><span class="p">).</span><span class="n">equalTo</span><span class="p">(</span><span class="m">1</span><span class="p">);</span>
</code></pre></div>

<p>(The generated SQL here would be <code>SELECT _user.id, _user.name, ... FROM _user WHERE _user.id = 1</code>.)</p>
<p>There are many expression methods like <code>equalTo</code> - see the documentation for <code>QueryExpression&lt;T&gt;</code> for a complete list.</p>
<p>You may add multiple criteria to a query by invoking <code>where</code> multiple times. Each criteria is combined together with a logical 'and'. For example, the following query will find all users whose <code>name</code> is "Bob" <em>and</em> <code>email</code> is not null:</p>
<div class="codehilite"><pre><span></span><code><span class="kd">final</span> <span class="n">query</span> <span class="o">=</span> <span class="n">Query</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
  <span class="p">..</span><span class="n">where</span><span class="p">((</span><span class="n">u</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">u</span><span class="p">.</span><span class="n">name</span><span class="p">).</span><span class="n">equalTo</span><span class="p">(</span><span class="s2">&quot;Bob&quot;</span><span class="p">)</span>
  <span class="p">..</span><span class="n">where</span><span class="p">((</span><span class="n">u</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">u</span><span class="p">.</span><span class="n">email</span><span class="p">).</span><span class="n">isNotNull</span><span class="p">();</span>
</code></pre></div>

<p>You may apply criteria to relationship properties, too. For nullable relationships, you can apply null/not null checks:</p>
<div class="codehilite"><pre><span></span><code><span class="kd">var</span> <span class="n">employedQuery</span> <span class="o">=</span> <span class="n">Query</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
  <span class="p">..</span><span class="n">where</span><span class="p">((</span><span class="n">p</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">p</span><span class="p">.</span><span class="n">company</span><span class="p">).</span><span class="n">isNotNull</span><span class="p">();</span>
</code></pre></div>

<p>More often, you use the <code>identifiedBy</code> expression for finding objects that belong to a specific object. For example, when finding all employees for a given company:</p>
<div class="codehilite"><pre><span></span><code><span class="kd">var</span> <span class="n">preferredQuery</span> <span class="o">=</span> <span class="n">Query</span><span class="o">&lt;</span><span class="n">Employee</span><span class="o">&gt;</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
  <span class="p">..</span><span class="n">where</span><span class="p">((</span><span class="n">e</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">e</span><span class="p">.</span><span class="n">company</span><span class="p">).</span><span class="n">identifiedBy</span><span class="p">(</span><span class="m">23</span><span class="p">);</span>
</code></pre></div>

<p>The above will only return employees who work for company with a primary key value of 23. It is equivalent to the following, and both are acceptable:</p>
<div class="codehilite"><pre><span></span><code><span class="kd">var</span> <span class="n">sameQuery</span> <span class="o">=</span> <span class="n">Query</span><span class="o">&lt;</span><span class="n">Employee</span><span class="o">&gt;</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
  <span class="p">..</span><span class="n">where</span><span class="p">((</span><span class="n">e</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">e</span><span class="p">.</span><span class="n">company</span><span class="p">.</span><span class="n">id</span><span class="p">).</span><span class="n">equalTo</span><span class="p">(</span><span class="m">23</span><span class="p">);</span>
</code></pre></div>

<p>Notice in the above that you may select properties of relationships when building a query. Since an employee 'belongs-to' a company, the employee table has a column to store the primary key of a company. This is called a foreign key column. When building a query that selects the primary key of a belongs-to relationship, Aqueduct can interpret this to use the foreign key column value.</p>
<p>For selecting properties that are not backed by a foreign key column in the table being queried, see the next section on Joins.</p>
<h2 id="including-relationships-in-a-fetch-aka-joins">Including Relationships in a Fetch (aka, Joins)</h2>
<p>A <code>Query&lt;T&gt;</code> can also fetch relationship properties. This allows queries to fetch entire model graphs and reduces the number of round-trips to a database.</p>
<p>By default, relationship properties are not fetched in a query and therefore aren't included in an object's <code>asMap()</code>. For example, consider the following definitions, where a <code>User</code> has-many <code>Task</code>s:</p>
<div class="codehilite"><pre><span></span><code><span class="kd">class</span> <span class="nc">User</span> <span class="kd">extends</span> <span class="n">ManagedObject</span><span class="o">&lt;</span><span class="n">_User</span><span class="o">&gt;</span> <span class="kd">implements</span> <span class="n">_User</span> <span class="p">{}</span>
<span class="kd">class</span> <span class="nc">_User</span> <span class="p">{</span>
  <span class="nd">@primaryKey</span>
  <span class="kt">int</span> <span class="n">id</span><span class="p">;</span>

  <span class="kt">String</span> <span class="n">name</span><span class="p">;</span>
  <span class="n">ManagedSet</span><span class="o">&lt;</span><span class="n">Task</span><span class="o">&gt;</span> <span class="n">tasks</span><span class="p">;</span>  
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">Task</span> <span class="kd">extends</span> <span class="n">ManagedObject</span><span class="o">&lt;</span><span class="n">_Task</span><span class="o">&gt;</span> <span class="kd">implements</span> <span class="n">_Task</span> <span class="p">{}</span>
<span class="kd">class</span> <span class="nc">_Task</span> <span class="p">{</span>
  <span class="nd">@primaryKey</span>
  <span class="kt">int</span> <span class="n">id</span><span class="p">;</span>

  <span class="nd">@Relate</span><span class="p">(</span><span class="err">#</span><span class="n">tasks</span><span class="p">)</span>
  <span class="n">User</span> <span class="n">user</span><span class="p">;</span>

  <span class="kt">String</span> <span class="n">contents</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>A <code>Query&lt;User&gt;</code> will fetch the <code>name</code> and <code>id</code> of each <code>User</code>. A <code>User</code>'s <code>tasks</code> are not fetched, so the data returned looks like this:</p>
<div class="codehilite"><pre><span></span><code><span class="kd">var</span> <span class="n">q</span> <span class="o">=</span> <span class="n">Query</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span><span class="p">(</span><span class="n">context</span><span class="p">);</span>
<span class="kd">var</span> <span class="n">users</span> <span class="o">=</span> <span class="kd">await</span> <span class="n">q</span><span class="p">.</span><span class="n">fetch</span><span class="p">();</span>

<span class="n">users</span><span class="p">.</span><span class="n">first</span><span class="p">.</span><span class="n">asMap</span><span class="p">()</span> <span class="o">==</span> <span class="p">{</span>
  <span class="s2">&quot;id&quot;</span><span class="o">:</span> <span class="m">1</span><span class="p">,</span>
  <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;Bob&quot;</span>
<span class="p">};</span> <span class="c1">// yup</span>
</code></pre></div>

<p>The <code>join()</code> method will tell a query to also include related objects. The following shows a fetch that gets users and their tasks:</p>
<div class="codehilite"><pre><span></span><code><span class="kd">var</span> <span class="n">q</span> <span class="o">=</span> <span class="n">Query</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
  <span class="p">..</span><span class="n">join</span><span class="p">(</span><span class="kd">set</span><span class="o">:</span> <span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">u</span><span class="p">.</span><span class="n">tasks</span><span class="p">);</span>
<span class="kd">var</span> <span class="n">users</span> <span class="o">=</span> <span class="kd">await</span> <span class="n">q</span><span class="p">.</span><span class="n">fetch</span><span class="p">();</span>

<span class="n">users</span><span class="p">.</span><span class="n">first</span><span class="p">.</span><span class="n">asMap</span><span class="p">()</span> <span class="o">==</span> <span class="p">{</span>
  <span class="s2">&quot;id&quot;</span><span class="o">:</span> <span class="m">1</span><span class="p">,</span>
  <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;Bob&quot;</span><span class="p">,</span>
  <span class="s2">&quot;tasks&quot;</span><span class="o">:</span> <span class="p">[</span>
      <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="o">:</span> <span class="m">1</span><span class="p">,</span> <span class="s2">&quot;contents&quot;</span><span class="o">:</span> <span class="s2">&quot;Take out trash&quot;</span><span class="p">,</span> <span class="s2">&quot;user&quot;</span> <span class="o">:</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="o">:</span> <span class="m">1</span><span class="p">}},</span>
      <span class="p">...</span>
  <span class="p">]</span>
<span class="p">};</span> <span class="c1">// yup</span>
</code></pre></div>

<p>When joining a has-many relationship, the <code>set:</code> argument takes a property selector that must select a <code>ManagedSet</code>. (When fetching a has-one or belongs-to relationship, use the <code>object:</code> argument.)</p>
<p>The method <code>join()</code> returns a new <code>Query&lt;T&gt;</code>, where <code>T</code> is the type of the joined object. That is, the above code could also be written as such:</p>
<div class="codehilite"><pre><span></span><code><span class="kd">var</span> <span class="n">q</span> <span class="o">=</span> <span class="n">Query</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span><span class="p">(</span><span class="n">context</span><span class="p">);</span>

<span class="c1">// type annotation added for clarity</span>
<span class="n">Query</span><span class="o">&lt;</span><span class="n">Task</span><span class="o">&gt;</span> <span class="n">taskSubQuery</span> <span class="o">=</span> <span class="n">q</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="kd">set</span><span class="o">:</span> <span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">u</span><span class="p">.</span><span class="n">tasks</span><span class="p">);</span>
</code></pre></div>

<h3 id="configuring-join-queries">Configuring Join Queries</h3>
<p>You do not execute a query created by a join, but you do configure it like any other query. (The parent query keeps track of the joined query and you execute the parent query.) For example, you may modify the properties that are returned for the joined objects:</p>
<div class="codehilite"><pre><span></span><code><span class="kd">var</span> <span class="n">q</span> <span class="o">=</span> <span class="n">Query</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span><span class="p">(</span><span class="n">context</span><span class="p">);</span>

<span class="n">q</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="kd">set</span><span class="o">:</span> <span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">u</span><span class="p">.</span><span class="n">tasks</span><span class="p">)</span>  
  <span class="p">..</span><span class="n">returningProperties</span><span class="p">((</span><span class="n">t</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="n">t</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">t</span><span class="p">.</span><span class="n">contents</span><span class="p">]);</span>

<span class="kd">final</span> <span class="n">usersAndTasks</span> <span class="o">=</span> <span class="kd">await</span> <span class="n">q</span><span class="p">.</span><span class="n">fetch</span><span class="p">();</span>  
</code></pre></div>

<p>You may also apply filtering criteria to a join query. Consider a <code>Parent</code> that has-many <code>Children</code>. When fetching parents and joining their children, a <code>where</code> expression on the join query impacts which children are returned, but does not impact which parents are returned. For example, the following query would fetch every parent, but would only include children who are greater than 1 years old:</p>
<div class="codehilite"><pre><span></span><code><span class="kd">final</span> <span class="n">q</span> <span class="o">=</span> <span class="n">Query</span><span class="o">&lt;</span><span class="n">Parent</span><span class="o">&gt;</span><span class="p">(</span><span class="n">context</span><span class="p">);</span>
<span class="n">q</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="kd">set</span><span class="o">:</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">p</span><span class="p">.</span><span class="n">children</span><span class="p">)</span>
  <span class="p">..</span><span class="n">where</span><span class="p">((</span><span class="n">c</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">c</span><span class="p">.</span><span class="n">age</span><span class="p">).</span><span class="n">greaterThan</span><span class="p">(</span><span class="m">1</span><span class="p">);</span>

<span class="kd">final</span> <span class="n">parentsAndTheirChildren</span> <span class="o">=</span> <span class="kd">await</span> <span class="n">q</span><span class="p">.</span><span class="n">fetch</span><span class="p">();</span>
</code></pre></div>

<h3 id="filtering-objects-by-their-relationships">Filtering Objects by Their Relationships</h3>
<p>However, consider if we applied a similar expression to the parent query - it would only return parents <em>who have children that are greater than 1 years old</em>.</p>
<div class="codehilite"><pre><span></span><code><span class="kd">final</span> <span class="n">q</span> <span class="o">=</span> <span class="n">Query</span><span class="o">&lt;</span><span class="n">Parent</span><span class="o">&gt;</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
  <span class="p">..</span><span class="n">where</span><span class="p">((</span><span class="n">c</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">c</span><span class="p">.</span><span class="n">children</span><span class="p">.</span><span class="n">haveAtLeastOneWhere</span><span class="p">.</span><span class="n">age</span><span class="p">).</span><span class="n">greaterThan</span><span class="p">(</span><span class="m">1</span><span class="p">);</span>
  <span class="p">..</span><span class="n">join</span><span class="p">(</span><span class="kd">set</span><span class="o">:</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">p</span><span class="p">.</span><span class="n">children</span><span class="p">);</span>

<span class="kd">final</span> <span class="n">parentsWithOlderChildren</span> <span class="o">=</span> <span class="kd">await</span> <span class="n">q</span><span class="p">.</span><span class="n">fetch</span><span class="p">();</span>
</code></pre></div>

<p>The difference is where the expression is applied. When applying it to the child query, it removes child objects that don't meet the criteria. When applying it to the parent query, it removes parents that don't meet the criteria. The property <code>haveAtLeastOneWhere</code> is specific to has-many relationships. When selecting properties of a has-one or belongs-to relationship, you access the property directly:</p>
<div class="codehilite"><pre><span></span><code><span class="kd">final</span> <span class="n">q</span> <span class="o">=</span> <span class="n">Query</span><span class="o">&lt;</span><span class="n">Child</span><span class="o">&gt;</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
  <span class="p">..</span><span class="n">where</span><span class="p">((</span><span class="n">p</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">p</span><span class="p">.</span><span class="n">parent</span><span class="p">.</span><span class="n">age</span><span class="p">).</span><span class="n">greaterThan</span><span class="p">(</span><span class="m">30</span><span class="p">)</span>
  <span class="p">..</span><span class="n">join</span><span class="p">(</span><span class="nl">object:</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">e</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>

<span class="kd">final</span> <span class="n">childrenWithParentsOver30</span> <span class="o">=</span> <span class="kd">await</span> <span class="n">q</span><span class="p">.</span><span class="n">fetch</span><span class="p">();</span>
</code></pre></div>

<p>Note that you may use relationship properties without explicitly joining the property. A SQL JOIN is still performed, but the related object is not included in the result set.</p>
<div class="codehilite"><pre><span></span><code><span class="kd">final</span> <span class="n">q</span> <span class="o">=</span> <span class="n">Query</span><span class="o">&lt;</span><span class="n">Child</span><span class="o">&gt;</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
  <span class="p">..</span><span class="n">where</span><span class="p">((</span><span class="n">p</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">p</span><span class="p">.</span><span class="n">parent</span><span class="p">.</span><span class="n">age</span><span class="p">).</span><span class="n">greaterThan</span><span class="p">(</span><span class="m">30</span><span class="p">);</span>

<span class="kd">final</span> <span class="n">employeesWithManagersOver30YearsOld</span> <span class="o">=</span> <span class="kd">await</span> <span class="n">q</span><span class="p">.</span><span class="n">fetch</span><span class="p">();</span>
</code></pre></div>

<h3 id="multiple-joins">Multiple Joins</h3>
<p>More than one join can be applied to a query, and subqueries can be nested. So, this is all valid, assuming the relationship properties exist:</p>
<div class="codehilite"><pre><span></span><code><span class="kd">var</span> <span class="n">q</span> <span class="o">=</span> <span class="n">Query</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
  <span class="p">..</span><span class="n">join</span><span class="p">(</span><span class="nl">object:</span> <span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">u</span><span class="p">.</span><span class="n">address</span><span class="p">);</span>

<span class="n">q</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="kd">set</span><span class="o">:</span> <span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">u</span><span class="p">.</span><span class="n">tasks</span><span class="p">)</span>
  <span class="p">..</span><span class="n">join</span><span class="p">(</span><span class="nl">object:</span> <span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">u</span><span class="p">.</span><span class="n">location</span><span class="p">);</span>
</code></pre></div>

<p>This would fetch all users, their addresses, all of their tasks, and the location for each of their tasks. You'd get a nice sized tree of objects here.</p>
<h2 id="reduce-functions-aka-aggregate-functions">Reduce Functions (aka, Aggregate Functions)</h2>
<p>Queries can also be used to perform functions like <code>count</code>, <code>sum</code>, <code>average</code>, <code>min</code> and <code>max</code>. Here's an example:</p>
<div class="codehilite"><pre><span></span><code><span class="kd">var</span> <span class="n">query</span> <span class="o">=</span> <span class="n">Query</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span><span class="p">(</span><span class="n">context</span><span class="p">);</span>
<span class="kd">var</span> <span class="n">numberOfUsers</span> <span class="o">=</span> <span class="kd">await</span> <span class="n">query</span><span class="p">.</span><span class="n">reduce</span><span class="p">.</span><span class="n">count</span><span class="p">();</span>
</code></pre></div>

<p>For reduce functions that use the value of some property, a property selector is used to identify that property.</p>
<div class="codehilite"><pre><span></span><code><span class="kd">var</span> <span class="n">averageSalary</span> <span class="o">=</span> <span class="kd">await</span> <span class="n">query</span><span class="p">.</span><span class="n">reduce</span><span class="p">.</span><span class="n">sum</span><span class="p">((</span><span class="n">u</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">u</span><span class="p">.</span><span class="n">salary</span><span class="p">);</span>
</code></pre></div>

<p>Any values configured in a <code>Query&lt;T&gt;</code> also impact the <code>reduce</code> function. For example, applying a <code>Query.where</code> and then executing a <code>sum</code> function will only sum the rows that meet the criteria of the where clause:</p>
<div class="codehilite"><pre><span></span><code><span class="kd">var</span> <span class="n">query</span> <span class="o">=</span> <span class="n">Query</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
  <span class="p">..</span><span class="n">where</span><span class="p">((</span><span class="n">u</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">u</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="n">equalTo</span><span class="p">(</span><span class="s2">&quot;Bob&quot;</span><span class="p">);</span>
<span class="kd">var</span> <span class="n">averageSalaryOfPeopleNamedBob</span> <span class="o">=</span> <span class="kd">await</span> <span class="n">query</span><span class="p">.</span><span class="n">reduce</span><span class="p">.</span><span class="n">sum</span><span class="p">((</span><span class="n">u</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">u</span><span class="p">.</span><span class="n">salary</span><span class="p">);</span>
</code></pre></div>

<h2 id="fallbacks">Fallbacks</h2>
<p>You may always execute arbitrary SQL with <code>PersistentStore.execute</code>. Note that the objects returned will be a <code>List&lt;List&lt;dynamic&gt;&gt;</code> - a list of rows, for each a list of columns.</p>
<p>You may also provide raw WHERE clauses with <code>Query.predicate</code>. A <code>QueryPredicate</code> is a <code>String</code> that is set as the query's where clause. A <code>QueryPredicate</code> has two properties, a format string and a <code>Map&lt;String, dynamic&gt;</code> of parameter values. The <code>format</code> string can (and should) parameterize any input values. Parameters are indicated in the format string using the <code>@</code> token:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// Creates a predicate that would only include instances where some column &quot;id&quot; is less than 2</span>
<span class="kd">var</span> <span class="n">predicate</span> <span class="o">=</span> <span class="n">QueryPredicate</span><span class="p">(</span><span class="s2">&quot;id &lt; @idVariable&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;idVariable&quot;</span> <span class="o">:</span> <span class="m">2</span><span class="p">});</span>
</code></pre></div>

<p>The text following the <code>@</code> token may contain <code>[A-Za-z0-9_]</code>. The resulting where clause will be formed by replacing each token with the matching key in the parameters map. The value is not transformed in any way, so it must be the appropriate type for the column. If a key is not present in the <code>Map</code>, an exception will be thrown. Extra keys will be ignored.</p>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        <a href="../executing_queries/" class="md-footer__link md-footer__link--prev" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Basic Queries
            </div>
          </div>
        </a>
      
      
        <a href="../transactions/" class="md-footer__link md-footer__link--next" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Transactions
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Built by Stable Kernel
          </div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": [], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}, "search": "../../assets/javascripts/workers/search.fb4a9340.min.js", "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.a1c7c35e.min.js"></script>
      
    
  </body>
</html>